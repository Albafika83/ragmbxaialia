<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload PDF - Traitement RAG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #2980b9;
            background-color: #f8f9fa;
        }

        .upload-area.dragover {
            border-color: #27ae60;
            background-color: #e8f5e8;
        }

        .upload-icon {
            font-size: 3em;
            color: #3498db;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #34495e;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        #fileInput {
            display: none;
        }

        .file-info {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .file-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .file-details {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .progress-container {
            background: #ecf0f1;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #3498db, #2980b9);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: #2c3e50;
            font-weight: 500;
        }

        .upload-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .upload-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .test-btn {
            background: #9b59b6;
        }

        .test-btn:hover {
            background: #8e44ad;
        }

        .result-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .result-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .collection-input {
            margin-bottom: 20px;
        }

        .collection-input label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
        }

        .collection-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .collection-input input:focus {
            outline: none;
            border-color: #3498db;
        }

        .context-info {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
            text-align: center;
            box-shadow: 0 2px 10px rgba(116, 185, 255, 0.2);
        }

        .context-info code {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÑ Upload PDF</h1>
            <p>Uploadez votre PDF pour l'indexer dans la base de donn√©es vectorielle</p>
            <div id="contextInfo" class="context-info"></div>
        </div>

        <div class="collection-input">
            <label for="collectionName">Nom de la collection:</label>
            <input type="text" id="collectionName" placeholder="Entrez le nom de la collection" value="documents">
        </div>

        <div class="collection-input">
            <label for="qdrantUrl">URL Qdrant Cloud:</label>
            <input type="text" id="qdrantUrl" placeholder="https://votre-cluster.region.cloud.qdrant.io:6333" value="https://dc6a6e15-ec9c-4a88-aeff-0da82686cb10.us-east4-0.gcp.cloud.qdrant.io:6333">
            <small style="color: #7f8c8d; font-size: 0.9em;">
                ‚ÑπÔ∏è Optionnel - Trouvez votre URL dans le dashboard Qdrant Cloud<br>
                Format: https://votre-cluster.region.cloud.qdrant.io:6333
            </small>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Glissez-d√©posez votre fichier PDF ici</div>
            <div class="upload-subtext">ou cliquez pour s√©lectionner un fichier</div>
            <input type="file" id="fileInput" accept=".pdf">
        </div>

        <div class="file-info" id="fileInfo">
            <h3>Fichier s√©lectionn√©:</h3>
            <div class="file-details" id="fileDetails"></div>
        </div>

        <div class="button-group">
            <button class="upload-btn test-btn" id="testBtn">üîç Tester l'API</button>
            <button class="upload-btn" id="uploadBtn" disabled>Uploader et Traiter</button>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Traitement en cours...</div>
        </div>

        <div class="result-container" id="resultContainer">
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        // Configuration API - Multiples endpoints √† tester
        const API_CONFIG = {
            possibleEndpoints: [
                'https://owui.alia.amella.fr/api/v1/embeddings',
                'https://owui.alia.amella.fr/v1/embeddings',
                'https://owui.alia.amella.fr/embeddings',
                'https://owui.alia.amella.fr/api/embeddings',
                'https://owui.alia.amella.fr/embed',
                'https://owui.alia.amella.fr/api/embed'
            ],
            workingEndpoint: null,
            jwtToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6Ijc0NTc1YWM4LTYzN2ItNGU3ZS1hNTgyLWEzNDQxODcyMjM1YSJ9.ua9qTWjB-90QpopXy7e4yZ9pn0-YHR7xcFXalBXdWfI',
            apiKey: 'sk-8c0afa46001c4a5a9f9c37545096461c',
            qdrantToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhY2Nlc3MiOiJtIn0.-5rVo0SRTGh4-G-wzuQM5ShCqXodXtmif803GtUDOtU'
        };

        // √âl√©ments DOM
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileDetails = document.getElementById('fileDetails');
        const uploadBtn = document.getElementById('uploadBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultContainer = document.getElementById('resultContainer');
        const resultContent = document.getElementById('resultContent');
        const collectionName = document.getElementById('collectionName');
        const qdrantUrl = document.getElementById('qdrantUrl');
        const contextInfo = document.getElementById('contextInfo');

        let selectedFile = null;

        // Gestion du drag & drop
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                handleFileSelect(files[0]);
            }
        });

        // Gestion de la s√©lection de fichier
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            selectedFile = file;
            fileDetails.innerHTML = `
                <strong>Nom:</strong> ${file.name}<br>
                <strong>Taille:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                <strong>Type:</strong> ${file.type}
            `;
            fileInfo.style.display = 'block';
            uploadBtn.disabled = false;
        }

        // Fonction pour extraire le texte du PDF
        async function extractTextFromPDF(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        // Ici, nous utilisons PDF.js pour extraire le texte
                        const loadingTask = pdfjsLib.getDocument(e.target.result);
                        const pdf = await loadingTask.promise;
                        let fullText = '';
                        
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText + '\n';
                        }
                        
                        resolve(fullText);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Fonction pour d√©couper le texte en chunks
        function chunkText(text, maxLength = 1000) {
            const chunks = [];
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            let currentChunk = '';
            
            for (const sentence of sentences) {
                if (currentChunk.length + sentence.length > maxLength) {
                    if (currentChunk.trim()) {
                        chunks.push(currentChunk.trim());
                    }
                    currentChunk = sentence;
                } else {
                    currentChunk += sentence + '.';
                }
            }
            
            if (currentChunk.trim()) {
                chunks.push(currentChunk.trim());
            }
            
            return chunks;
        }

        // Fonction pour obtenir les embeddings
        async function getEmbeddings(text) {
            if (!API_CONFIG.workingEndpoint) {
                throw new Error('Aucun endpoint API valide trouv√©. Veuillez d\'abord tester l\'API.');
            }

            // Utiliser le format qui fonctionne, mais remplacer le texte
            let requestBody = { ...API_CONFIG.workingFormat };
            
            // Adapter le format selon ce qui fonctionne
            if (requestBody.input !== undefined) {
                requestBody.input = Array.isArray(requestBody.input) ? [text] : text;
            } else if (requestBody.text !== undefined) {
                requestBody.text = text;
            }

            const response = await fetch(API_CONFIG.workingEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_CONFIG.jwtToken}`,
                    'X-API-Key': API_CONFIG.apiKey
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erreur API embeddings: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            
            // Essayer diff√©rents formats de r√©ponse
            if (data.data && data.data[0] && data.data[0].embedding) {
                return data.data[0].embedding;
            } else if (data.embedding) {
                return data.embedding;
            } else if (data.embeddings) {
                return data.embeddings[0];
            } else {
                throw new Error('Format de r√©ponse API non reconnu');
            }
        }

        // Fonction pour stocker dans Qdrant Cloud
        async function storeInQdrant(chunks, embeddings, collectionName) {
            // URLs Qdrant Cloud possibles √† tester
            const possibleQdrantUrls = [];
            
            // Priorit√© √† l'URL saisie par l'utilisateur
            if (qdrantUrl.value && qdrantUrl.value.trim()) {
                possibleQdrantUrls.push(qdrantUrl.value.trim());
            }
            
            // URLs √† tester selon le mode de fonctionnement
            if (window.location.protocol === 'http:' && window.location.hostname === 'localhost') {
                // Mode serveur local - utiliser le proxy
                possibleQdrantUrls.push('/qdrant');
            } else {
                // Mode fichier local - essayer l'URL directe (sera bloqu√© par CORS)
                possibleQdrantUrls.push(
                    'https://dc6a6e15-ec9c-4a88-aeff-0da82686cb10.us-east4-0.gcp.cloud.qdrant.io:6333'
                );
            }

            let workingQdrantUrl = null;

            // Tester les URLs Qdrant Cloud
            for (const baseUrl of possibleQdrantUrls) {
                try {
                    console.log(`üîç Test de l'URL Qdrant Cloud: ${baseUrl}`);
                    
                    // Headers pour Qdrant Cloud
                    const headers = {
                        'Content-Type': 'application/json',
                        'api-key': API_CONFIG.qdrantToken
                    };
                    
                    const testResponse = await fetch(`${baseUrl}/collections`, {
                        method: 'GET',
                        headers: headers
                    });

                    if (testResponse.ok || testResponse.status === 404) {
                        console.log(`‚úÖ URL Qdrant Cloud fonctionnelle: ${baseUrl}`);
                        workingQdrantUrl = baseUrl;
                        break;
                    } else {
                        const errorText = await testResponse.text();
                        console.log(`‚ùå Erreur ${testResponse.status}: ${errorText}`);
                    }
                } catch (error) {
                    console.log(`‚ùå Erreur avec ${baseUrl}: ${error.message}`);
                }
            }

            if (!workingQdrantUrl) {
                // D√©tecter le contexte d'ex√©cution
                const isGitHubPages = window.location.hostname.includes('github.io');
                const isLocalFile = window.location.protocol === 'file:';
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                let contextMessage = '';
                let solutions = '';
                
                if (isGitHubPages) {
                    contextMessage = `
                        <p>üåê Vous utilisez GitHub Pages (<code>${window.location.hostname}</code>). 
                        L'API embeddings fonctionne parfaitement, mais Qdrant Cloud bloque les requ√™tes 
                        depuis GitHub Pages pour des raisons de s√©curit√© (CORS).</p>
                    `;
                    
                    solutions = `
                        <h4>üöÄ Solution recommand√©e :</h4>
                        <ol>
                            <li><strong>T√©l√©chargez les fichiers localement</strong> depuis <a href="https://github.com/albafika83/ragmbxaialia/archive/main.zip" target="_blank">GitHub</a></li>
                            <li><strong>Lancez le serveur proxy inclus :</strong>
                                <br>‚Ä¢ Windows : Double-cliquez sur <code>start_server.bat</code>
                                <br>‚Ä¢ Linux/Mac : <code>./start_server.sh</code>
                                <br>‚Ä¢ Ou manuellement : <code>python proxy_server.py</code>
                            </li>
                            <li><strong>Ouvrez</strong> <code>http://localhost:8000</code></li>
                        </ol>
                        
                        <h4>üîß Alternative rapide :</h4>
                        <p>Installez une extension CORS dans votre navigateur :</p>
                        <ul>
                            <li><strong>Chrome :</strong> "CORS Unblock" ou "Allow CORS"</li>
                            <li><strong>Firefox :</strong> "CORS Everywhere"</li>
                        </ul>
                    `;
                } else if (isLocalFile) {
                    contextMessage = `
                        <p>üìÅ Vous ouvrez le fichier directement (<code>file://</code>). 
                        Pour des raisons de s√©curit√©, les navigateurs bloquent les requ√™tes vers Qdrant Cloud.</p>
                    `;
                    
                    solutions = `
                        <h4>üöÄ Solutions :</h4>
                        <ol>
                            <li><strong>Lancez le serveur proxy :</strong>
                                <br>‚Ä¢ Windows : Double-cliquez sur <code>start_server.bat</code>
                                <br>‚Ä¢ Linux/Mac : <code>./start_server.sh</code>
                                <br>‚Ä¢ Ou : <code>python proxy_server.py</code>
                            </li>
                            <li><strong>Serveur web simple :</strong> <code>python -m http.server 8000</code></li>
                            <li><strong>Extension CORS :</strong> Installez "Allow CORS" dans votre navigateur</li>
                        </ol>
                    `;
                }
                
                // Message d'information sur les probl√®mes CORS
                showResult('error', `
                    <h3>‚ö†Ô∏è Probl√®me CORS avec Qdrant Cloud</h3>
                    ${contextMessage}
                    
                    ${solutions}
                    
                    <h4>üìä √âtat de votre configuration :</h4>
                    <ul>
                        <li>‚úÖ <strong>API Embeddings :</strong> Fonctionnelle</li>
                        <li>‚úÖ <strong>Cluster Qdrant :</strong> ${qdrantUrl.value || 'https://dc6a6e15-ec9c-4a88-aeff-0da82686cb10.us-east4-0.gcp.cloud.qdrant.io:6333'}</li>
                        <li>‚úÖ <strong>Token :</strong> Configur√©</li>
                        <li>‚ùå <strong>CORS :</strong> Bloqu√© par le navigateur</li>
                    </ul>
                    
                    <p><small>üí° <strong>Conseil :</strong> Le serveur proxy inclus est la solution la plus simple et s√©curis√©e.</small></p>
                `);
                
                throw new Error('Probl√®me CORS : Qdrant Cloud n\'est pas accessible depuis ce contexte.');
            }

            // Fonction pour obtenir les headers Qdrant Cloud
            function getQdrantHeaders() {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // Qdrant Cloud utilise toujours le header 'api-key' m√™me pour les tokens JWT
                headers['api-key'] = API_CONFIG.qdrantToken;
                
                return headers;
            }

            // Cr√©er la collection si elle n'existe pas
            console.log(`üìù Cr√©ation de la collection "${collectionName}" sur Qdrant Cloud...`);
            
            // Format standard Qdrant Cloud pour cr√©er une collection
            const createCollectionConfig = {
                vectors: {
                    size: embeddings[0].length,
                    distance: 'Cosine'
                }
            };
            
            // Tester diff√©rentes m√©thodes HTTP pour cr√©er la collection
            const createMethods = ['PUT', 'POST'];
            let collectionCreated = false;
            
            for (const method of createMethods) {
                try {
                    console.log(`  üìù Cr√©ation collection: ${method} /collections/${collectionName}`);
                    const createResponse = await fetch(`${workingQdrantUrl}/collections/${collectionName}`, {
                        method: method,
                        headers: getQdrantHeaders(),
                        body: JSON.stringify(createCollectionConfig)
                    });
                    
                    if (createResponse.ok) {
                        console.log(`  ‚úÖ Collection cr√©√©e avec succ√®s (${method})`);
                        collectionCreated = true;
                        break;
                    } else if (createResponse.status === 409) {
                        console.log(`  ‚úÖ Collection existe d√©j√†`);
                        collectionCreated = true;
                        break;
                    } else {
                        const errorText = await createResponse.text();
                        console.log(`  ‚ö†Ô∏è Erreur cr√©ation collection ${method} ${createResponse.status}: ${errorText}`);
                    }
                } catch (error) {
                    console.log(`  ‚ö†Ô∏è Erreur r√©seau cr√©ation collection ${method}: ${error.message}`);
                }
            }
            
            if (!collectionCreated) {
                console.log(`  ‚ö†Ô∏è Tentative d'insertion directe...`);
            }

            // Ins√©rer les points dans Qdrant Cloud
            console.log('üìù Insertion des points dans Qdrant Cloud...');
            const points = chunks.map((chunk, index) => ({
                id: Date.now() + index,
                vector: embeddings[index],
                payload: {
                    text: chunk,
                    source: selectedFile.name,
                    created_at: new Date().toISOString(),
                    chunk_index: index
                }
            }));

            // Tester diff√©rentes m√©thodes et endpoints pour l'insertion
            const insertConfigs = [
                { method: 'PUT', endpoint: `/collections/${collectionName}/points` },
                { method: 'POST', endpoint: `/collections/${collectionName}/points` },
                { method: 'PUT', endpoint: `/collections/${collectionName}/points/upsert` },
                { method: 'POST', endpoint: `/collections/${collectionName}/points/upsert` },
                { method: 'PATCH', endpoint: `/collections/${collectionName}/points` }
            ];
            
            console.log(`  üìù Test d'insertion de ${points.length} points...`);
            
            let insertSuccessful = false;
            let lastError = null;
            
            for (const config of insertConfigs) {
                try {
                    console.log(`  üìù Test insertion: ${config.method} ${config.endpoint}`);
                    const response = await fetch(`${workingQdrantUrl}${config.endpoint}`, {
                        method: config.method,
                        headers: getQdrantHeaders(),
                        body: JSON.stringify({
                            points: points
                        })
                    });

                    if (response.ok) {
                        console.log(`  ‚úÖ ${points.length} points ins√©r√©s avec succ√®s (${config.method})!`);
                        insertSuccessful = true;
                        return await response.json();
                    } else {
                        const errorText = await response.text();
                        lastError = `${config.method} ${response.status}: ${errorText}`;
                        console.log(`  ‚ùå Erreur insertion ${config.method} ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    lastError = `${config.method}: ${error.message}`;
                    console.log(`  ‚ö†Ô∏è Erreur r√©seau insertion ${config.method}: ${error.message}`);
                }
            }
            
            if (!insertSuccessful) {
                throw new Error(`Erreur Qdrant Cloud - Toutes les m√©thodes d'insertion ont √©chou√©. Derni√®re erreur: ${lastError}`);
            }

            return await response.json();
        }

        // Fonction principale d'upload
        async function uploadAndProcess() {
            if (!selectedFile) return;

            uploadBtn.disabled = true;
            progressContainer.style.display = 'block';
            resultContainer.style.display = 'none';

            try {
                // √âtape 1: Extraction du texte
                updateProgress(10, 'Extraction du texte du PDF...');
                const text = await extractTextFromPDF(selectedFile);

                // √âtape 2: D√©coupage en chunks
                updateProgress(30, 'D√©coupage du texte...');
                const chunks = chunkText(text);

                // √âtape 3: G√©n√©ration des embeddings
                updateProgress(50, 'G√©n√©ration des embeddings...');
                const embeddings = [];
                for (let i = 0; i < chunks.length; i++) {
                    const embedding = await getEmbeddings(chunks[i]);
                    embeddings.push(embedding);
                    updateProgress(50 + (i / chunks.length) * 30, `Embeddings: ${i + 1}/${chunks.length}`);
                }

                // √âtape 4: Stockage dans Qdrant
                updateProgress(80, 'Stockage dans la base de donn√©es...');
                await storeInQdrant(chunks, embeddings, collectionName.value);

                // Succ√®s
                updateProgress(100, 'Traitement termin√©!');
                showResult('success', `
                    <h3>‚úÖ Succ√®s!</h3>
                    <p>Le PDF a √©t√© trait√© avec succ√®s:</p>
                    <ul>
                        <li><strong>Fichier:</strong> ${selectedFile.name}</li>
                        <li><strong>Chunks cr√©√©s:</strong> ${chunks.length}</li>
                        <li><strong>Collection:</strong> ${collectionName.value}</li>
                        <li><strong>Embeddings g√©n√©r√©s:</strong> ${embeddings.length}</li>
                    </ul>
                `);

            } catch (error) {
                console.error('Erreur:', error);
                showResult('error', `
                    <h3>‚ùå Erreur</h3>
                    <p>Une erreur s'est produite lors du traitement:</p>
                    <p><strong>${error.message}</strong></p>
                `);
            } finally {
                uploadBtn.disabled = false;
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);
            }
        }

        function updateProgress(percentage, message) {
            progressFill.style.width = percentage + '%';
            progressText.textContent = message;
        }

        function showResult(type, content) {
            resultContainer.className = `result-container result-${type}`;
            resultContent.innerHTML = content;
            resultContainer.style.display = 'block';
        }

        // Test de l'API avant l'upload - teste diff√©rents endpoints
        async function testAPI() {
            console.log('üîç Recherche de l\'endpoint API correct...');
            
            // Diff√©rents formats de requ√™te √† tester
            const testFormats = [
                {
                    body: { model: 'mxbai-embed-large:latest', input: ['test'] },
                    description: 'Format OpenAI (array)'
                },
                {
                    body: { model: 'mxbai-embed-large:latest', input: 'test' },
                    description: 'Format OpenAI (string)'
                },
                {
                    body: { model: 'mxbai-embed-large:latest', text: 'test' },
                    description: 'Format text field'
                },
                {
                    body: { text: 'test' },
                    description: 'Format simple'
                }
            ];
            
            for (const endpoint of API_CONFIG.possibleEndpoints) {
                console.log(`\nüåê Test de l'endpoint: ${endpoint}`);
                
                for (const format of testFormats) {
                    try {
                        console.log(`  üìù Test avec ${format.description}...`);
                        
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${API_CONFIG.jwtToken}`,
                                'X-API-Key': API_CONFIG.apiKey
                            },
                            body: JSON.stringify(format.body)
                        });
                        
                        console.log(`  ‚úÖ R√©ponse: ${response.status} ${response.statusText}`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`  üéâ SUCC√àS! Endpoint trouv√©: ${endpoint}`);
                            console.log(`  üìä Format: ${format.description}`);
                            console.log(`  üìã Donn√©es:`, data);
                            
                            // Sauvegarder l'endpoint qui fonctionne
                            API_CONFIG.workingEndpoint = endpoint;
                            API_CONFIG.workingFormat = format.body;
                            
                            // Tester aussi Qdrant Cloud maintenant
                            console.log('üîç Test de l\'acc√®s Qdrant Cloud...');
                            let qdrantStatus = 'Non test√©';
                            
                            try {
                                // Headers pour Qdrant Cloud
                                const qdrantHeaders = {
                                    'Content-Type': 'application/json',
                                    'api-key': API_CONFIG.qdrantToken
                                };
                                
                                // Test des URLs Qdrant Cloud typiques
                                const qdrantTestUrls = [];
                                
                                // Priorit√© √† l'URL saisie par l'utilisateur
                                if (qdrantUrl.value && qdrantUrl.value.trim()) {
                                    qdrantTestUrls.push(`${qdrantUrl.value.trim()}/collections`);
                                }
                                
                                // URLs √† tester selon le mode de fonctionnement
                                if (window.location.protocol === 'http:' && window.location.hostname === 'localhost') {
                                    // Mode serveur local - utiliser le proxy
                                    qdrantTestUrls.push('/qdrant/collections');
                                } else {
                                    // Mode fichier local - essayer l'URL directe (sera bloqu√© par CORS)
                                    qdrantTestUrls.push(
                                        'https://dc6a6e15-ec9c-4a88-aeff-0da82686cb10.us-east4-0.gcp.cloud.qdrant.io:6333/collections'
                                    );
                                }
                                
                                for (const url of qdrantTestUrls) {
                                    try {
                                        const qdrantResponse = await fetch(url, {
                                            method: 'GET',
                                            headers: qdrantHeaders
                                        });
                                        
                                        if (qdrantResponse.ok || qdrantResponse.status === 404) {
                                            qdrantStatus = '‚úÖ Accessible';
                                            break;
                                        }
                                    } catch (e) {
                                        continue;
                                    }
                                }
                                
                                if (qdrantStatus === 'Non test√©') {
                                    qdrantStatus = '‚ö†Ô∏è URLs seront test√©es lors de l\'upload';
                                }
                            } catch (error) {
                                qdrantStatus = '‚ùå Erreur - URL sera test√©e lors de l\'upload';
                            }
                            
                            // Afficher le succ√®s √† l'utilisateur
                            showResult('success', `
                                <h3>‚úÖ API Embeddings Pr√™te!</h3>
                                <p>Endpoint API trouv√© et configur√©:</p>
                                <ul>
                                    <li><strong>URL:</strong> ${endpoint}</li>
                                    <li><strong>Format:</strong> ${format.description}</li>
                                    <li><strong>Statut:</strong> Fonctionnel</li>
                                    <li><strong>Qdrant Cloud:</strong> ${qdrantStatus}</li>
                                </ul>
                                <p>Vous pouvez maintenant uploader votre PDF!</p>
                                <p><small>üí° Pour Qdrant Cloud, saisissez votre URL de cluster dans le champ ci-dessus pour de meilleures performances.</small></p>
                            `);
                            
                            return; // Arr√™ter le test une fois qu'on a trouv√©
                        } else {
                            const errorText = await response.text();
                            console.log(`  ‚ùå Erreur: ${errorText}`);
                        }
                        
                    } catch (error) {
                        console.log(`  ‚ö†Ô∏è  Erreur r√©seau: ${error.message}`);
                    }
                }
            }
            
            // Si aucun endpoint ne fonctionne
            console.error('‚ùå Aucun endpoint API valide trouv√©!');
            showResult('error', `
                <h3>‚ùå Erreur de Configuration</h3>
                <p>Aucun endpoint API valide trouv√©. Endpoints test√©s:</p>
                <ul>
                    ${API_CONFIG.possibleEndpoints.map(endpoint => `<li>${endpoint}</li>`).join('')}
                </ul>
                <p>Veuillez v√©rifier vos credentials et l'URL de l'API.</p>
            `);
        }

        // Event listener pour le bouton upload
        uploadBtn.addEventListener('click', uploadAndProcess);

        // Event listener pour le bouton test
        document.getElementById('testBtn').addEventListener('click', testAPI);

        // Afficher le contexte d'ex√©cution
        function showExecutionContext() {
            const isGitHubPages = window.location.hostname.includes('github.io');
            const isLocalFile = window.location.protocol === 'file:';
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            let message = '';
            
            if (isGitHubPages) {
                message = `üåê Mode GitHub Pages - <code>${window.location.hostname}</code> | ‚ö†Ô∏è CORS limit√© pour Qdrant Cloud`;
            } else if (isLocalhost) {
                message = `üè† Mode serveur local - <code>${window.location.href}</code> | ‚úÖ Tous les services disponibles`;
            } else if (isLocalFile) {
                message = `üìÅ Mode fichier local - <code>file://</code> | ‚ö†Ô∏è CORS limit√© pour Qdrant Cloud`;
            } else {
                message = `üåê Mode web - <code>${window.location.hostname}</code> | √âtat CORS √† d√©terminer`;
            }
            
            contextInfo.innerHTML = message;
        }

        // Test de l'API au chargement de la page
        document.addEventListener('DOMContentLoaded', () => {
            showExecutionContext();
            testAPI();
        });

        // Charger PDF.js
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
        script.onload = function() {
            // Configuration du worker PDF.js
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        };
        document.head.appendChild(script);
    </script>
</body>
</html> 